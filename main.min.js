"use strict";const BACKEND_URL="https://redepop-backend.onrender.com",MANIFEST_URL=window.REDEPOP_MANIFEST_URL||"./manifest.json",COLOR_SCHEMES=[{primary:"#FF4EB2",secondary:"#310404"},{primary:"#FF4EB2",secondary:"#310404"},{primary:"#FF4EB2",secondary:"#310404"},{primary:"#FF4EB2",secondary:"#310404"},{primary:"#FF4EB2",secondary:"#310404"}];function shuffleArray(e){let t=[...e];for(let r=t.length-1;r>0;r--){let o=Math.floor(Math.random()*(r+1));[t[r],t[o]]=[t[o],t[r]]}return t}function setRandomColorScheme(){let e=COLOR_SCHEMES[Math.floor(Math.random()*COLOR_SCHEMES.length)];document.documentElement.style.setProperty("--dynamic-primary",e.primary),document.documentElement.style.setProperty("--dynamic-secondary",e.secondary),document.documentElement.style.setProperty("--dynamic-gradient",`linear-gradient(135deg, ${e.primary}, ${e.secondary})`)}function createIntersectionObserver(){return new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){let t=e.target;t.dataset.src&&(t.classList.add("loading"),t.src=t.dataset.src,t.onload=()=>{t.classList.remove("loading"),t.classList.add("loaded")},t.removeAttribute("data-src"))}})},{rootMargin:"50px",threshold:.1})}function debounce(e,t){let r;return function o(...a){let n=()=>{clearTimeout(r),e(...a)};clearTimeout(r),r=setTimeout(n,t)}}const orderModal=document.getElementById("orderModal"),orderModalCloseBtn=document.getElementById("orderModalCloseBtn"),orderForm=document.getElementById("orderForm"),orderSubmitBtn=document.getElementById("orderSubmitBtn"),orderFormMessage=document.getElementById("orderFormMessage"),catalog=document.getElementById("catalog"),loadingOverlay=document.getElementById("loadingOverlay");let platformSelect,gameIdInput;function updateOrderProductInfo(e,t,r){document.getElementById("orderProductName").textContent=e||"",document.getElementById("orderProductImg").src=t||"",document.getElementById("orderProductId").value=r||""}function el(e,t,r={}){let o=document.createElement(e);for(let[a,n]of(t&&(o.className=t),Object.entries(r)))"text"===a?o.textContent=n:"html"===a?o.innerHTML=n:o.setAttribute(a,n);return o}function buildProductCard({src:e,name:t,secret:r,isExtra:o,isFeatured:a,overlayUrl:n},d){let i=`product-card${o?" extra-product":""}${a?" featured":""}`,l=el("div",i,{"data-secret":r});if(l.style.animationDelay=`${.05*d}s`,a){let s=el("div","featured-badge",{text:"⭐"});l.appendChild(s)}let c=el("div","product-img-wrapper"),m=el("img","product-img",{"data-src":e,alt:t,loading:"lazy",decoding:"async",src:'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"%3E%3Crect fill="%23f0f0f0" width="300" height="300"/%3E%3C/svg%3E'});if(n){let u=el("img","product-overlay",{src:n,alt:"frame",loading:"lazy"});c.appendChild(m),c.appendChild(u)}else c.appendChild(m);let g=el("div","product-name",{text:t});return l.appendChild(c),l.appendChild(g),o&&(l.hidden=!0),l}function buildTierSection(e,t){let r=el("section","reward-tier",{"data-tier":e.id}),o=parseInt(e.id.split("-")[1])||1;r.style.animationDelay=`${.2*o}s`;let a=el("div","tier-header",{text:e.label||e.id});r.appendChild(a);let n=el("div","product-grid");r.appendChild(n);let d=Number.isInteger(e.showFirst)?e.showFirst:3,i=Array.isArray(e.items)?e.items:[];i=shuffleArray(i);let l=Math.floor(2*Math.random())+1,s=new Set;for(;s.size<Math.min(l,Math.min(d,i.length));)s.add(Math.floor(Math.random()*Math.min(d,i.length)));if(i.forEach((r,o)=>{let a=r.url?r.url:t+r.file,i=r.name||r.file||r.url||"Produto",l=o>=d,c=s.has(o)&&!l,m=buildProductCard({src:a,name:i,secret:e.id,isExtra:l,isFeatured:c,overlayUrl:t+"overlay.webp"},o);n.appendChild(m)}),i.length>d){let c=el("button","veja-mais-btn",{"data-tier":e.id});c.appendChild(el("span","btn-text",{text:"VEJA MAIS"})),c.appendChild(el("span","arrow-icon",{html:"&#9660;"})),r.appendChild(c)}return r}async function loadCatalog(){try{setRandomColorScheme(),loadingOverlay&&(loadingOverlay.style.display="flex");let[e]=await Promise.all([fetch(MANIFEST_URL,{cache:"no-cache"}),new Promise(e=>setTimeout(e,800))]);if(!e.ok)throw Error(`HTTP ${e.status}`);let t=await e.json(),r=(t.baseUrl||"").trim(),o=Array.isArray(t.tiers)?t.tiers:[];catalog.innerHTML="";let a=createIntersectionObserver();o.forEach(e=>{let t=buildTierSection(e,r);catalog.appendChild(t);let o=t.querySelectorAll(".product-img[data-src]");o.forEach(e=>a.observe(e))}),loadingOverlay&&setTimeout(()=>{loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},500)},300)}catch(n){console.error("Gagal memuat manifest:",n),catalog.innerHTML='<p style="color:red;text-align:center;padding:20px;">Falha ao carregar cat\xe1logo. Tente novamente.</p>',loadingOverlay&&setTimeout(()=>{loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},300)},100)}}let isCPFValid=!1;function validateCPF(e){if(11!==(e=e.replace(/[^\d]+/g,"")).length||/^(\d)\1+$/.test(e))return!1;let t=0,r;for(let o=1;o<=9;o++)t+=parseInt(e.substring(o-1,o))*(11-o);if((r=t%11<2?0:11-t%11)!==parseInt(e.substring(9,10)))return!1;t=0;for(let a=1;a<=10;a++)t+=parseInt(e.substring(a-1,a))*(12-a);return(r=t%11<2?0:11-t%11)===parseInt(e.substring(10,11))}document.addEventListener("click",e=>{let t=e.target.closest(".product-card");if(!t)return;t.style.transform="scale(0.95)",setTimeout(()=>{t.style.transform=""},150);let r=t.querySelector(".product-name"),o=t.querySelector(".product-img"),a=r?r.textContent.trim():"",n=o?o.src||o.dataset.src:"",d=t.getAttribute("data-secret")||"";orderForm.reset(),isCPFValid=!1,isSecretCodeValid=!1,orderFormMessage.textContent="",orderSubmitBtn.disabled=!0;let i=document.getElementById("secretCodeStatus");i&&(i.innerHTML=""),updateOrderProductInfo(a,n,d),orderModal.classList.add("active"),"function"==typeof applyGameIdRules&&applyGameIdRules()}),document.addEventListener("click",e=>{let t=e.target.closest(".veja-mais-btn");if(!t)return;let r=t.getAttribute("data-tier"),o=document.querySelector(`section[data-tier="${r}"]`);if(!o)return;let a=o.querySelectorAll(".extra-product"),n=t.classList.toggle("expanded"),d=t.querySelector(".btn-text"),i=t.querySelector(".arrow-icon");d&&i&&(d.textContent=n?"VER MENOS":"VEJA MAIS",i.innerHTML=n?"&#9650;":"&#9660;"),a.forEach((e,t)=>{n?(e.hidden=!1,e.style.opacity="1",e.style.transform="scale(1) translateY(0)",e.style.animationDelay=`${.1*t}s`,e.classList.add("fade-in")):(e.hidden=!0,e.classList.remove("fade-in"),e.style.opacity="",e.style.transform="")})}),orderModalCloseBtn&&orderModalCloseBtn.addEventListener("click",()=>{orderModal.classList.remove("active")});const RULE_GROUP_A=new Set(["POPBRA","POP888","POP678","POPPG","POP555","POPLUA","POPBEM","POPCEU"]),RULE_GROUP_B=new Set(["POPDEZ","POPWB","POPBOA","POPFLU","POPBIS"]);function getGameIdConfig(){if(!platformSelect||!platformSelect.value)return{regex:/^\d{4,12}$/,min:4,max:12,msg:"Selecione a plataforma para validar o ID de Jogo"};let e=platformSelect.value;return RULE_GROUP_A.has(e)?{regex:/^\d{4,8}$/,min:4,max:8,msg:`ID de Jogo (${e}) precisa 4-8 d\xedgitos num\xe9ricos, sem espa\xe7o!`}:RULE_GROUP_B.has(e)?{regex:/^\d{9,12}$/,min:9,max:12,msg:`ID de Jogo (${e}) precisa 9-12 d\xedgitos num\xe9ricos, sem espa\xe7o!`}:{regex:/^\d{4,12}$/,min:4,max:12,msg:"Selecione a plataforma para validar o ID de Jogo"}}function applyGameIdRules(){if(!gameIdInput||!platformSelect)return;let{min:e,max:t}=getGameIdConfig();gameIdInput.setAttribute("minlength",String(e)),gameIdInput.setAttribute("maxlength",String(t)),gameIdInput.setAttribute("pattern",`\\d{${e},${t}}`),gameIdInput.placeholder=`Digite ${e}-${t} d\xedgitos num\xe9ricos`,validateGameId()}function validateGameId(){if(!gameIdInput||!platformSelect)return;let{regex:e,msg:t}=getGameIdConfig(),r=gameIdInput.value.trim();if(!r){gameIdInput.setCustomValidity(""),gameIdInput.style.borderColor="",orderFormMessage.textContent.startsWith("ID de Jogo")&&(orderFormMessage.textContent="",orderFormMessage.style.color="");return}if(!/^\d+$/.test(r)){let o="ID de Jogo deve conter apenas n\xfameros.";gameIdInput.setCustomValidity(o),gameIdInput.style.borderColor="#FF4EB2",orderFormMessage.textContent=o,orderFormMessage.style.color="red";return}if(!e.test(r)){gameIdInput.setCustomValidity(t),gameIdInput.style.borderColor="#FF4EB2",orderFormMessage.textContent=t,orderFormMessage.style.color="red";return}gameIdInput.setCustomValidity(""),gameIdInput.style.borderColor="",(orderFormMessage.textContent===t||orderFormMessage.textContent.startsWith("ID de Jogo"))&&(orderFormMessage.textContent="",orderFormMessage.style.color="")}let isSecretCodeValid=!1;const secretCodeInput=document.getElementById("secretCode"),secretCodeStatus=document.getElementById("secretCodeStatus"),validationCache=new Map;let validationAbortController=null;function showSpinner(){secretCodeStatus&&(secretCodeStatus.innerHTML=`
    <svg aria-label="Validando..." width="22" height="22" viewBox="0 0 50 50" role="img">
      <circle cx="25" cy="25" r="20" fill="none" stroke="#FF4EB2" stroke-width="6" opacity="0.2"></circle>
      <circle cx="25" cy="25" r="20" fill="none" stroke="#FF4EB2" stroke-width="6" stroke-linecap="round" stroke-dasharray="1,150" stroke-dashoffset="0">
        <animate attributeName="stroke-dasharray" values="1,150;90,150;90,150" dur="1.4s" repeatCount="indefinite"></animate>
        <animate attributeName="stroke-dashoffset" values="0;-35;-124" dur="1.4s" repeatCount="indefinite"></animate>
        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1.4s" repeatCount="indefinite"></animateTransform>
      </circle>
    </svg>
  `)}function showCheck(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="checkmark-circle" style="color:#28c650;font-size:1.6em"></ion-icon>')}function showWarning(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="warning" style="color:#FF4EB2;font-size:1.6em"></ion-icon>')}function clearStatus(){secretCodeStatus&&(secretCodeStatus.innerHTML="")}async function performValidation(e,t){let r=`${t}-${e}`;if(validationCache.has(r))return console.log("✅ Using cached validation result"),validationCache.get(r);validationAbortController&&validationAbortController.abort(),validationAbortController=new AbortController;let o=setTimeout(()=>validationAbortController.abort(),8e3);try{showSpinner(),orderFormMessage.textContent="Validando c\xf3digo...",orderFormMessage.style.color="#444";let a=await fetch(`${BACKEND_URL}/validate?product_id=${encodeURIComponent(t)}&secret_code=${encodeURIComponent(e)}`,{signal:validationAbortController.signal,headers:{Connection:"keep-alive"}});clearTimeout(o);let n=await a.json();return validationCache.set(r,n),setTimeout(()=>validationCache.delete(r),3e5),n}catch(d){if(clearTimeout(o),"AbortError"===d.name)return console.log("⏱️ Request timeout or cancelled"),{status:"error",message:"Timeout - tente novamente"};return console.error("❌ Validation error:",d),{status:"error",message:"Erro de conex\xe3o"}}}const debouncedValidation=debounce(async function(e,t){let r=await performValidation(e,t);"valid"===r.status?(isSecretCodeValid=!0,orderFormMessage.textContent="C\xf3digo v\xe1lido! Voc\xea pode enviar.",orderFormMessage.style.color="green",showCheck()):"used"===r.status?(isSecretCodeValid=!1,orderFormMessage.textContent="C\xf3digo j\xe1 foi utilizado!",orderFormMessage.style.color="red",showWarning()):(isSecretCodeValid=!1,orderFormMessage.textContent=r.message||"C\xf3digo inv\xe1lido!",orderFormMessage.style.color="red",showWarning()),updateOrderSubmitBtn()},600);function updateOrderSubmitBtn(){orderSubmitBtn&&orderForm&&(orderSubmitBtn.disabled=!(orderForm.checkValidity()&&isCPFValid&&isSecretCodeValid))}secretCodeInput&&secretCodeInput.addEventListener("input",function(){let e=this.value.trim(),t=document.getElementById("orderProductId").value;isSecretCodeValid=!1,updateOrderSubmitBtn(),8===e.length&&t?(clearStatus(),orderFormMessage.textContent="Digite o c\xf3digo completo...",orderFormMessage.style.color="#444",debouncedValidation(e,t)):e.length>0?(clearStatus(),orderFormMessage.textContent="C\xf3digo deve ter 8 caracteres",orderFormMessage.style.color="#444"):(clearStatus(),orderFormMessage.textContent="")}),orderForm&&orderForm.addEventListener("submit",async function(e){if(e.preventDefault(),!orderForm.checkValidity()||!isCPFValid||!isSecretCodeValid){orderForm.reportValidity(),orderFormMessage.textContent="Verifique os campos e tente novamente.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1;return}orderSubmitBtn.disabled=!0,orderFormMessage.textContent="Enviando...";let t=document.getElementById("orderProductName").textContent.trim(),r=document.getElementById("orderProductImg").src;if(!t){orderFormMessage.textContent="Erro: Produto n\xe3o detectado.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1;return}let o={productId:document.getElementById("orderProductId").value,productName:t,productImg:r,fullName:document.getElementById("fullName").value.trim(),phone:document.getElementById("phone").value.trim(),zip:document.getElementById("zip").value.trim(),state:document.getElementById("state").value,city:document.getElementById("city").value,address:document.getElementById("address").value.trim(),neighborhood:document.getElementById("neighborhood").value.trim(),street:document.getElementById("street").value.trim(),number:document.getElementById("number").value.trim(),platform:document.getElementById("platform").value,gameId:document.getElementById("gameId").value.trim(),cpf:document.getElementById("cpf").value.trim(),secretCode:document.getElementById("secretCode").value.trim()};try{let a=await fetch(`${BACKEND_URL}/order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await a.json();if("success"===n.status){orderFormMessage.textContent="Pedido enviado com sucesso! Entraremos em contato em breve.",orderFormMessage.style.color="green";let d=`${o.productId}-${o.secretCode}`;validationCache.delete(d),setTimeout(()=>{orderModal.classList.remove("active"),orderForm.reset(),orderSubmitBtn.disabled=!0,orderFormMessage.textContent="",isSecretCodeValid=!1,isCPFValid=!1},2500)}else orderFormMessage.textContent=n.message||"Erro ao enviar pedido. Tente novamente.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1}catch(i){console.error("Erro ao enviar pedido:",i),orderFormMessage.textContent="Erro ao enviar. Verifique sua conex\xe3o.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1}}),document.addEventListener("DOMContentLoaded",()=>{platformSelect=document.getElementById("platform"),gameIdInput=document.getElementById("gameId");let e=document.getElementById("cpf");if(e){function t(){validateCPF(e.value)?(isCPFValid=!0,"CPF inv\xe1lido!"===orderFormMessage.textContent&&(orderFormMessage.textContent="",orderFormMessage.style.color="")):(isCPFValid=!1,orderFormMessage.textContent="CPF inv\xe1lido!",orderFormMessage.style.color="red"),updateOrderSubmitBtn()}e.addEventListener("input",function(){this.value=this.value.replace(/[^\d]/g,""),this.value.length>11&&(this.value=this.value.slice(0,11))}),e.addEventListener("blur",t),e.addEventListener("input",t)}let r=document.getElementById("fullName");r&&r.addEventListener("input",function(){/\d/.test(this.value)?(this.setCustomValidity("Nome n\xe3o pode conter n\xfameros!"),this.style.borderColor="#FF4EB2",orderFormMessage.textContent="Nome n\xe3o pode conter n\xfameros!",orderFormMessage.style.color="red"):(this.setCustomValidity(""),this.style.borderColor="","Nome n\xe3o pode conter n\xfameros!"===orderFormMessage.textContent&&(orderFormMessage.textContent="",orderFormMessage.style.color=""))}),platformSelect&&platformSelect.addEventListener("change",()=>{applyGameIdRules(),updateOrderSubmitBtn()}),gameIdInput&&gameIdInput.addEventListener("input",()=>{validateGameId(),updateOrderSubmitBtn()}),applyGameIdRules(),loadCatalog()});let ticking=!1;function updateOnScroll(){ticking=!1}document.addEventListener("scroll",()=>{ticking||(requestAnimationFrame(updateOnScroll),ticking=!0)});const criticalImages=["https://i.ibb.co/BHYkmXfs/Whatsapp-Transparent.gif","https://i.ibb.co/s9x87GHJ/Telegram-logo.gif"];criticalImages.forEach(e=>{let t=new Image;t.src=e}),function(){let e=["\uD83C\uDF38","\uD83C\uDF3A","\uD83C\uDF37"],t=[],r=[{x:0,y:0,width:100,height:20},{x:15,y:10,width:70,height:85},{x:0,y:90,width:100,height:10}];function o(e,t,o=5){return r.some(r=>e>=r.x-o&&e<=r.x+r.width+o&&t>=r.y-o&&t<=r.y+r.height+o)}function a(e,r){let o=window.innerWidth,a=window.innerHeight,n=e/100*o,d=r/100*a;return t.some(e=>{let t=e.x/100*o,r=e.y/100*a;return 150>Math.sqrt(Math.pow(n-t,2)+Math.pow(d-r,2))})}function n(){let e=0,t=[{x:0,y:25,width:10,height:15},{x:90,y:25,width:10,height:15},{x:0,y:45,width:10,height:15},{x:90,y:45,width:10,height:15},{x:0,y:70,width:10,height:15},{x:90,y:70,width:10,height:15}];for(;e<100;){let r=t[Math.floor(Math.random()*t.length)],n=r.x+Math.random()*r.width,d=r.y+Math.random()*r.height;if(!o(n,d,10)&&!a(n,d))return{x:n,y:d};e++}return null}function d(){let r=document.createElement("div");r.style.position="fixed",r.style.top="0",r.style.left="0",r.style.width="100%",r.style.height="100%",r.style.pointerEvents="none",r.style.zIndex="-1",r.style.overflow="hidden";let o=0;for(let a=0;a<8&&o<8;a++){let d=n();if(!d){console.log("Could not find safe position for flower",a);continue}let i=document.createElement("div");i.className="flower-decoration",i.textContent=e[Math.floor(Math.random()*e.length)],t.push(d),i.style.left=d.x+"%",i.style.top=d.y+"%";let l=2+.5*Math.random();i.style.fontSize=l+"rem",i.style.animationDelay=-5*Math.random()+"s";let s=5+3*Math.random();i.style.animationDuration=s+"s",i.style.pointerEvents="none",i.style.userSelect="none",i.style.webkitUserSelect="none",r.appendChild(i),o++}console.log(`Created ${o} flowers safely positioned`),document.body.appendChild(r)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(d,100)}):setTimeout(d,100)}();