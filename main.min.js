"use strict";const BACKEND_URL="https://redepop-backend.onrender.com",MANIFEST_URL=window.REDEPOP_MANIFEST_URL||"./manifest.json",COLOR_SCHEMES=[{primary:"#eb0b0a",secondary:"#310404"},{primary:"#d32f2f",secondary:"#1b0000"},{primary:"#f44336",secondary:"#310404"},{primary:"#e53935",secondary:"#2c0000"},{primary:"#c62828",secondary:"#1a0000"},];function shuffleArray(e){let t=[...e];for(let r=t.length-1;r>0;r--){let o=Math.floor(Math.random()*(r+1));[t[r],t[o]]=[t[o],t[r]]}return t}function setRandomColorScheme(){let e=COLOR_SCHEMES[Math.floor(Math.random()*COLOR_SCHEMES.length)];document.documentElement.style.setProperty("--dynamic-primary",e.primary),document.documentElement.style.setProperty("--dynamic-secondary",e.secondary),document.documentElement.style.setProperty("--dynamic-gradient",`linear-gradient(135deg, ${e.primary}, ${e.secondary})`)}function createIntersectionObserver(){return new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){let t=e.target;t.dataset.src&&(t.classList.add("loading"),t.src=t.dataset.src,t.onload=()=>{t.classList.remove("loading"),t.classList.add("loaded")},t.removeAttribute("data-src"))}})},{rootMargin:"50px",threshold:.1})}const orderModal=document.getElementById("orderModal"),orderModalCloseBtn=document.getElementById("orderModalCloseBtn"),orderForm=document.getElementById("orderForm"),orderSubmitBtn=document.getElementById("orderSubmitBtn"),orderFormMessage=document.getElementById("orderFormMessage"),catalog=document.getElementById("catalog"),loadingOverlay=document.getElementById("loadingOverlay");let platformSelect,gameIdInput;function updateOrderProductInfo(e,t,r){document.getElementById("orderProductName").textContent=e||"",document.getElementById("orderProductImg").src=t||"",document.getElementById("orderProductId").value=r||""}function el(e,t,r={}){let o=document.createElement(e);for(let[a,n]of(t&&(o.className=t),Object.entries(r)))"text"===a?o.textContent=n:"html"===a?o.innerHTML=n:o.setAttribute(a,n);return o}function buildProductCard({src:e,name:t,secret:r,isExtra:o,isFeatured:a},n){let d=`product-card${o?" extra-product":""}${a?" featured":""}`,s=el("div",d,{"data-secret":r});if(s.style.animationDelay=`${.05*n}s`,a){let i=el("div","featured-badge",{text:"‚≠ê"});s.appendChild(i)}let l=el("img","product-img",{"data-src":e,alt:t,loading:"lazy",decoding:"async",src:'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"%3E%3Crect fill="%23f0f0f0" width="300" height="300"/%3E%3C/svg%3E'}),c=el("div","product-name",{text:t});return s.appendChild(l),s.appendChild(c),o&&(s.hidden=!0),s}function buildTierSection(e,t){let r=el("section","reward-tier",{"data-tier":e.id}),o=parseInt(e.id.split("-")[1])||1;r.style.animationDelay=`${.2*o}s`;let a=el("div","tier-header",{text:e.label||e.id});r.appendChild(a);let n=el("div","product-grid");r.appendChild(n);let d=Number.isInteger(e.showFirst)?e.showFirst:3,s=Array.isArray(e.items)?e.items:[];s=shuffleArray(s);let i=Math.floor(2*Math.random())+1,l=new Set;for(;l.size<Math.min(i,Math.min(d,s.length));)l.add(Math.floor(Math.random()*Math.min(d,s.length)));if(s.forEach((r,o)=>{let a=r.url?r.url:t+r.file,s=r.name||r.file||r.url||"Produto",i=o>=d,c=l.has(o)&&!i,m=buildProductCard({src:a,name:s,secret:e.id,isExtra:i,isFeatured:c},o);n.appendChild(m)}),s.length>d){let c=el("button","veja-mais-btn",{"data-tier":e.id});c.appendChild(el("span","btn-text",{text:"VEJA MAIS"})),c.appendChild(el("span","arrow-icon",{html:"&#9660;"})),r.appendChild(c)}return r}async function loadCatalog(){try{setRandomColorScheme(),loadingOverlay&&(loadingOverlay.style.display="flex");let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),r=await fetch(MANIFEST_URL,{cache:"force-cache",signal:e.signal});if(clearTimeout(t),!r.ok)throw Error(`HTTP ${r.status}`);let o=await r.json(),a=(o.baseUrl||"").trim(),n=Array.isArray(o.tiers)?o.tiers:[];catalog.innerHTML="";let d=document.createDocumentFragment(),s=createIntersectionObserver();n.forEach(e=>{let t=buildTierSection(e,a);d.appendChild(t),t.querySelectorAll(".product-img[data-src]").forEach(e=>s.observe(e))}),catalog.appendChild(d),loadingOverlay&&setTimeout(()=>{loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},300)},200)}catch(i){console.error("Gagal memuat manifest:",i),catalog.innerHTML='<p style="color:red;text-align:center;padding:20px;">Falha ao carregar cat\xe1logo. Tente novamente.</p>',loadingOverlay&&setTimeout(()=>{loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},300)},500)}}function validateCPF(e){if(11!==(e=e.replace(/[^\d]+/g,"")).length||/^(\d)\1+$/.test(e))return!1;let t=0,r;for(let o=1;o<=9;o++)t+=parseInt(e.substring(o-1,o))*(11-o);if((r=(r=t%11)<2?0:11-r)!==parseInt(e.substring(9,10)))return!1;t=0;for(let a=1;a<=10;a++)t+=parseInt(e.substring(a-1,a))*(12-a);return(r=(r=t%11)<2?0:11-r)===parseInt(e.substring(10,11))}document.addEventListener("click",e=>{let t=e.target.closest(".product-card");if(!t)return;t.style.transform="scale(0.95)",setTimeout(()=>{t.style.transform=""},150);let r=t.querySelector(".product-name"),o=t.querySelector(".product-img"),a=r?r.textContent.trim():"",n=o?o.src||o.dataset.src:"",d=t.getAttribute("data-secret")||"";orderForm.reset(),isCPFValid=!1,isSecretCodeValid=!1,orderFormMessage.textContent="",orderSubmitBtn.disabled=!0;let s=document.getElementById("secretCodeStatus");s&&(s.innerHTML=""),updateOrderProductInfo(a,n,d),orderModal.classList.add("active"),"function"==typeof applyGameIdRules&&applyGameIdRules()}),document.addEventListener("click",e=>{let t=e.target.closest(".veja-mais-btn");if(!t)return;let r=t.getAttribute("data-tier"),o=document.querySelector(`section[data-tier="${r}"]`);if(!o)return;let a=o.querySelectorAll(".extra-product"),n=t.classList.toggle("expanded"),d=t.querySelector(".btn-text"),s=t.querySelector(".arrow-icon");d&&s&&(d.textContent=n?"VER MENOS":"VEJA MAIS",s.innerHTML=n?"&#9650;":"&#9660;"),a.forEach((e,t)=>{n?(e.hidden=!1,e.style.opacity="1",e.style.transform="scale(1) translateY(0)",e.style.animationDelay=`${.1*t}s`,e.classList.add("fade-in")):(e.hidden=!0,e.classList.remove("fade-in"),e.style.opacity="",e.style.transform="")})}),orderModalCloseBtn&&orderModalCloseBtn.addEventListener("click",()=>orderModal.classList.remove("active"));let isCPFValid=!1,isSecretCodeValid=!1;const cpfInput=document.getElementById("cpf");cpfInput&&cpfInput.addEventListener("input",function(){this.value=this.value.replace(/[^\d]/g,""),this.value.length>11&&(this.value=this.value.slice(0,11))});const fullNameInput=document.getElementById("fullName");fullNameInput&&fullNameInput.addEventListener("input",function(){/\d/.test(this.value)?(this.setCustomValidity("Nome n\xe3o pode conter n\xfameros!"),this.style.borderColor="#eb0b0a",orderFormMessage.textContent="Nome n\xe3o pode conter n\xfameros!",orderFormMessage.style.color="red"):(this.setCustomValidity(""),this.style.borderColor="","Nome n\xe3o pode conter n\xfameros!"===orderFormMessage.textContent&&(orderFormMessage.textContent="",orderFormMessage.style.color=""))});const RULE_GROUP_A=new Set(["POPBRA","POP888","POP678","POPPG","POP555","POPLUA","POPBEM","POPCEU"]),RULE_GROUP_B=new Set(["POPDEZ","POPWB","POPBOA","POPFLU"]);function getGameIdConfig(){if(!platformSelect||!platformSelect.value)return{regex:/^\d{4,12}$/,min:4,max:12,msg:"Selecione a plataforma para validar o ID de Jogo"};let e=platformSelect.value;return RULE_GROUP_A.has(e)?{regex:/^\d{4,8}$/,min:4,max:8,msg:`ID de Jogo (${e}) precisa 4-8 d\xedgitos num\xe9ricos, sem espa\xe7o!`}:RULE_GROUP_B.has(e)?{regex:/^\d{9,12}$/,min:9,max:12,msg:`ID de Jogo (${e}) precisa 9-12 d\xedgitos num\xe9ricos, sem espa\xe7o!`}:{regex:/^\d{4,12}$/,min:4,max:12,msg:"Selecione a plataforma para validar o ID de Jogo"}}function applyGameIdRules(){if(!gameIdInput||!platformSelect)return;let{min:e,max:t}=getGameIdConfig();gameIdInput.setAttribute("minlength",String(e)),gameIdInput.setAttribute("maxlength",String(t)),gameIdInput.setAttribute("pattern",`\\d{${e},${t}}`),gameIdInput.placeholder=`Digite ${e}-${t} d\xedgitos num\xe9ricos`,validateGameId()}function validateGameId(){if(!gameIdInput||!platformSelect)return;let{regex:e,msg:t}=getGameIdConfig(),r=gameIdInput.value.trim();if(!r){gameIdInput.setCustomValidity(""),gameIdInput.style.borderColor="",orderFormMessage.textContent.startsWith("ID de Jogo")&&(orderFormMessage.textContent="",orderFormMessage.style.color="");return}if(!/^\d+$/.test(r)){let o="ID de Jogo deve conter apenas n\xfameros.";gameIdInput.setCustomValidity(o),gameIdInput.style.borderColor="#eb0b0a",orderFormMessage.textContent=o,orderFormMessage.style.color="red";return}if(!e.test(r)){gameIdInput.setCustomValidity(t),gameIdInput.style.borderColor="#eb0b0a",orderFormMessage.textContent=t,orderFormMessage.style.color="red";return}gameIdInput.setCustomValidity(""),gameIdInput.style.borderColor="",(orderFormMessage.textContent===t||orderFormMessage.textContent.startsWith("ID de Jogo"))&&(orderFormMessage.textContent="",orderFormMessage.style.color="")}const secretCodeInput=document.getElementById("secretCode"),secretCodeStatus=document.getElementById("secretCodeStatus");function showSpinner(){secretCodeStatus&&(secretCodeStatus.innerHTML=`
    <svg aria-label="Validando..." width="22" height="22" viewBox="0 0 50 50" role="img">
      <circle cx="25" cy="25" r="20" fill="none" stroke="#eb0b0a" stroke-width="6" opacity="0.2"></circle>
      <circle cx="25" cy="25" r="20" fill="none" stroke="#eb0b0a" stroke-width="6" stroke-linecap="round" stroke-dasharray="1,150" stroke-dashoffset="0">
        <animate attributeName="stroke-dasharray" values="1,150;90,150;90,150" dur="1.4s" repeatCount="indefinite"></animate>
        <animate attributeName="stroke-dashoffset" values="0;-35;-124" dur="1.4s" repeatCount="indefinite"></animate>
        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1.4s" repeatCount="indefinite"></animateTransform>
      </circle>
    </svg>
  `)}function showCheck(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="checkmark-circle" style="color:#28c650;font-size:1.6em"></ion-icon>')}function showWarning(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="warning" style="color:#eb0b0a;font-size:1.6em"></ion-icon>')}function clearStatus(){secretCodeStatus&&(secretCodeStatus.innerHTML="")}function updateOrderSubmitBtn(){orderSubmitBtn&&orderForm&&(orderSubmitBtn.disabled=!(orderForm.checkValidity()&&isCPFValid&&isSecretCodeValid))}secretCodeInput&&secretCodeInput.addEventListener("input",async function(){let e=this.value.trim(),t=document.getElementById("orderProductId").value;if(isSecretCodeValid=!1,updateOrderSubmitBtn(),e.length>4&&t){showSpinner(),orderFormMessage.textContent="Validando c\xf3digo...",orderFormMessage.style.color="#444";try{let r=await fetch(`${BACKEND_URL}/validate?product_id=${encodeURIComponent(t)}&secret_code=${encodeURIComponent(e)}`),o=await r.json();"valid"===o.status?(isSecretCodeValid=!0,orderFormMessage.textContent="C\xf3digo v\xe1lido! Voc\xea pode enviar.",orderFormMessage.style.color="green",showCheck()):(isSecretCodeValid=!1,orderFormMessage.textContent="C\xf3digo inv\xe1lido ou j\xe1 utilizado!",orderFormMessage.style.color="red",showWarning())}catch(a){isSecretCodeValid=!1,orderFormMessage.textContent="Erro ao validar c\xf3digo!",orderFormMessage.style.color="red",showWarning()}}else isSecretCodeValid=!1,orderFormMessage.textContent="",clearStatus();updateOrderSubmitBtn()}),orderForm&&orderForm.addEventListener("submit",async function(e){if(e.preventDefault(),!orderForm.checkValidity()||!isCPFValid||!isSecretCodeValid){orderForm.reportValidity(),orderFormMessage.textContent="Verifique os campos e tente novamente.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1;return}orderSubmitBtn.disabled=!0,orderFormMessage.textContent="Enviando...";let t=document.getElementById("orderProductName").textContent.trim(),r=document.getElementById("orderProductImg").src;if(!t){orderFormMessage.textContent="Erro: Produto n\xe3o detectado.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1;return}let o={productId:document.getElementById("orderProductId").value,productName:t,productImg:r,fullName:document.getElementById("fullName").value.trim(),phone:document.getElementById("phone").value.trim(),zip:document.getElementById("zip").value.trim(),state:document.getElementById("state").value,city:document.getElementById("city").value,address:document.getElementById("address").value.trim(),neighborhood:document.getElementById("neighborhood").value.trim(),street:document.getElementById("street").value.trim(),number:document.getElementById("number").value.trim(),platform:document.getElementById("platform").value,gameId:document.getElementById("gameId").value.trim(),cpf:document.getElementById("cpf").value.trim(),secretCode:document.getElementById("secretCode").value.trim()};try{let a=await fetch(`${BACKEND_URL}/order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),n=await a.json();"success"===n.status?(orderFormMessage.textContent="Pedido enviado com sucesso! Entraremos em contato em breve.",orderFormMessage.style.color="green",setTimeout(()=>{orderModal.classList.remove("active"),orderForm.reset(),orderSubmitBtn.disabled=!0,orderFormMessage.textContent=""},2500)):(orderFormMessage.textContent=n.message||"Erro ao enviar pedido. Tente novamente.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1)}catch(d){console.error("Erro ao enviar pedido:",d),orderFormMessage.textContent="Erro ao enviar. Verifique sua conex\xe3o.",orderFormMessage.style.color="red",orderSubmitBtn.disabled=!1}}),document.addEventListener("DOMContentLoaded",()=>{platformSelect=document.getElementById("platform"),gameIdInput=document.getElementById("gameId");let e=document.getElementById("cpf");if(e){function t(){validateCPF(e.value)?(isCPFValid=!0,"CPF inv\xe1lido!"===orderFormMessage.textContent&&(orderFormMessage.textContent="",orderFormMessage.style.color="")):(isCPFValid=!1,orderFormMessage.textContent="CPF inv\xe1lido!",orderFormMessage.style.color="red"),updateOrderSubmitBtn()}e.addEventListener("blur",t),e.addEventListener("input",t)}platformSelect&&platformSelect.addEventListener("change",()=>{applyGameIdRules(),updateOrderSubmitBtn()}),gameIdInput&&gameIdInput.addEventListener("input",()=>{validateGameId(),updateOrderSubmitBtn()}),applyGameIdRules(),loadCatalog()});let ticking=!1;function updateOnScroll(){ticking=!1}document.addEventListener("scroll",()=>{ticking||(requestAnimationFrame(updateOnScroll),ticking=!0)});const criticalImages=["https://i.ibb.co/BHYkmXfs/Whatsapp-Transparent.gif","https://i.ibb.co/s9x87GHJ/Telegram-logo.gif"];criticalImages.forEach(e=>{let t=new Image;t.src=e});const maxRetries=3;let retryCount=0;async function fetchWithRetry(e,t){for(;retryCount<3;)try{let r=await fetch(e,t);if(r.ok)return r;throw Error(`HTTP ${r.status}`)}catch(o){if(3==++retryCount)throw o;await new Promise(e=>setTimeout(e,1e3*retryCount))}}